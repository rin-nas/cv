# Назначение

ПО состоит из 2-х скриптов:

1. Загрузка URL и конвертация веб-страницы в файлы формата DOM HTML и [Markdown](https://guides.github.com/features/mastering-markdown/).
2. Распознавание и извлечение именованных сущностей из неструктурированного текста (из файла Markdown).

Скрипты используются для загрузки (импортирования) резюме и вакансий из разных сайтов, их обработки и добавления на сайт `https://rabota.ru`.

# Требования к рабочему окружению

* ОС, совместимая с `Linux Ubuntu x64 v16.x` или более поздняя
* `1 GB` оперативной памяти
* `32 Mb` свободного места на диске
* `NodeJS v8.9.0` или более поздняя ([инструкция по установке](https://nodejs.org/en/download/package-manager/#debian-and-ubuntu-based-linux-distributions))

# Установка

```bash
$ git clone git@git.rabota.space:rdw/rabota-importer.git
$ cd rabota-importer
$ chmod +x ./install.sh && ./install.sh
```

# Структура папок проекта

Папка               | Описание
--------------------|---------------------------------------------------------------------------------------------------
`dev`               | Набор разных файлов, применяемых в разработке, для продуктивного окружения не используются
`dict`              | Словари, используемые для распознавания именованных сущностей
`lib`               | Библиотеки программного кода
`log`               | Папка для выгрузки обработанных файлов, место хранения кук
`node_modules`      | Модули для `NodeJS`
`phantomjs_modules` | Модули для `PhantomJS` 
`test`              | Набор тестовых экземпляров для тестирования распознавания сущностей
`tmp`               | Папка для кеша `PhantomJS` и временных файлов
`vendor`            | Сторонние библиотеки, которые используются в проекте
`vendor/bin`        | Сторонние исполняемые файлы, которые используются в проекте

# Использование скриптов

## Выгрузка веб-страницы в файл

**Формат вызова**

`$ ./import.sh <опции…> [2> <errorFile>]`
    
В квадратных скобках указана необязательная часть.

**Показать все опции**

`$ ./import.sh` или `$ cat import.txt` выводит в консоль терминала:

```
Назначение:
    Загрузка URL и конвертация веб-страницы в файлы формата DOM HTML и Markdown

Использование:
    $ ./import.sh <опции...>

Опции обязательные: 
    --config-file=<значение>        Файл конфигурации (config.*.js)
    --url=<значение>                URL для загрузки

Опции необязательные: 
    --output-file-prefix=<значение> Префикс файлов для записи на диск, по-умолчанию "page"
    --username=<значение>           Имя пользователя для авторизации на сайте через форму ввода
    --password=<значение>           Пароль пользователя для авторизации на сайте через форму ввода
    --cookies-file=<значение>       Файл со списком кук вместо авторизации по логину и паролю.
                                    Список кук должен быть в формате Firefox плагина "Cookies Manager+" (*.txt) 
                                    или в формате Firefox плагина "Сookie Quick Manager" (*.json)
    --http-user-agent=<значение>    HTTP заголовок "User-Agent", который нужно передать в браузер
    --http-referer=<значение>       HTTP заголовок "Referer", который нужно передать в браузер
    --verbose                       Выводить подробную/расширенную информацию
    --no-color                      Отключить покраску цветом сообщений, выводимых в терминал
    --color                         Включить покраску цветом сообщений, если вывод перенаправляется не в терминал
    --proxy=<address>:<port>        HTTP прокси-сервер, например: 192.168.1.42:8080

Документация:
    $ cat README.md
```

**Пример вызова**

`$ ./import.sh --config-file=config.resume.js --url="https://ya.ru" --output-file-prefix=ya`

**Особенности работы**

* Скрипт может загружать веб-страницы с поддержкой `JavaScript`, `AJAX`, `Cookie`, сеансов, перенаправлений и авторизации (вход по логину и паролю).
* Из ресурсов веб-страницы изображения, аудио, видео и шрифты по ссылкам (кроме [`data:URI`](https://en.wikipedia.org/wiki/Data_URI_scheme)) не загружаются (нет необходимости).
За счёт этого экономится трафик, увеличивается скорость работы, снижается количество запросов к серверам и нагрузка на них.
* Максимальное время выполнения скрипта — 35 секунд (настраивается в `import.sh`)
* Максимальное время ожидания загрузки ресурсов (`*.css`, `*.js`, `…`) — 20 секунд (настраивается в `import.js`)
* Скрипт имеет защиту от зацикливания по URL
* Для своей работы скрипт использует консольный браузер [PhantomJS](http://phantomjs.org/) (исполняемый файл `./vendor/bin/phantomjs`)

**На выходе записываются файлы**

Если сервер отвечает с типом содержимого `text/html`:

1. `./log/<output-file-pefix>.input.dom.html` — файл с исходным DOM HTML, который сформировал браузер после загрузки страницы и выполнения javascript скриптов на этапе DOMContentLoaded.

2. `./log/<output-file-pefix>.output.dom.html` — файл с отфильтрованным DOM HTML.
Можно настраивать элемент DOM для выгрузки в HTML через указание CSS селектора в конфигурационном файле, по умолчанию это `body`.
В блоке `<head>` в теге `<meta name="source" …>` хранится ссылка на источник выгрузки, дата и время выгрузки. В HTML на выходе отсутствуют: 
    * скрипты `<script>`
    * стили `<style>`
    * комментарии `<!-- … -->`
    * скрытые/невидимые элементы `display:none; visibility:hidden; opacity:0` 
    * элементы с отступами за пределами видимости экрана монитора
    * атрибуты тегов с обработчиками событий `on*="…"`
    * атрибуты тегов `style="…"`

3. `./log/<output-file-pefix>.md` — файл в формате [Markdown](https://guides.github.com/features/mastering-markdown/).
При конвертации из DOM HTML в Markdown содержимое тегов `<iframe>` игнорируется.
Внизу файла дописывается ссылка на источник выгрузки, дата и время выгрузки. 
Текущая реализация конвертации из HTML в Markdown неполная, но поддерживает обработку основных HTML элементов: 
    * параграфы (`<p>`)
    * переносы строк (`<br/>`) 
    * заголовки (`<h1>`, … `<h6>`)
    * элементы списков (`<li>`) 
    * ссылки (`<a href="…" title="…">…</a>`)
    * изображения (`<img src="…" alt="…"/>`)

Если сервер отвечает с типом содержимого `application/json`:
* `./log/<output-file-pefix>.json` — файл в формате [JSON](http://www.json.org/). 
Файл сохраняется в форматированном виде с отступами, структура данных остаётся в неизменном виде.

Обязательные файлы для хранения кук (cookie):
1. `./log/<config-type>~[<username>]@cookies-persistent.txt` — для постоянных кук. 
Тип конфига `<config-type>` берётся из значения параметра `--config-file`, формат: `config.<config-type>.js`.
Имя пользователя `<username>` будет записано, если оно было передано через опцию `--username` командной строки.
2. `./log/<config-type>~[<username>]@<hostname>.cookies.json` — для сессионных кук. 

В случае возникновения ошибки файлы записаны не будут, а скрипт вернёт код возврата `1`. 

**Потоки**

1. В `STDOUT` пишутся:
    * `белым цветом`: сообщения PhantomJS о ходе работы скрипта (начало операции/шага, сводная информация, статистика)
    * `зелёным цветом`: сообщения об успешных операциях/шагах
    * `синим цветом`: 
        * сообщения о перенаправлениях на другой URL
        * данные POST запроса 
        * сообщения скриптов веб-страницы, выведенные в консоль браузера (методы `console.*()`)
    * `оранжевым цветом`: сообщения с предупреждениями — допустимые логикой скрипта ошибки (скрипт не прерывает работу)
2. В `STDERR` пишутся (`красным цветом`):
    * сообщения об ошибках выполнения PhantomJS (скрипт прерывает работу)
    * сообщения об ошибках выполнения скриптов веб-страницы (скрипт не прерывает работу) 

### Сценарий авторизации (шаги)

Сценарий авторизации выполняется, если существуют параметры `url` и `username` и `password` или только `cookiesFile`, 
переданные через опции командной строки или через файл конфигурации.

1. Загружаем страницу `startUrl` (его передали скрипту через параметр `--url`)
2. Если `startUrl` изменился (ответ сервера с кодом 301), то заменяем его на новый
3. Проверяем, авторизован ли пользователь на странице `startUrl` (по наличию формы авторизации или «магических» меток)
4. Если пользователь авторизован, сохраняем результат загрузки страницы `startUrl` и завершаем работу (успех)
5. Если не удалось определить, авторизован ли пользователь, то завершаем работу с ошибкой
6. Если передан только параметр `cookiesFile`, то переходим к пункту `14`.  
7. Если на странице `startUrl` формы авторизации нет, загружаем страницу `authUrl`
8. Если на странице `authUrl` формы авторизации нет, завершаем работу с ошибкой авторизации
9. Заполняем форму авторизации (вводим имя пользователя и пароль, отмечаем флаг «запомнить», если он есть) и отправляем данные на сервер на `authPostUrl` (`<form action="authPostUrl">`)
10. Загружаем страницу `authPostUrl`
11. Проверяем, авторизован ли пользователь на странице `authPostUrl` (по наличию формы авторизации или «магических» меток)
12. Если не удалось определить, авторизован ли пользователь, то завершаем работу с ошибкой
13. Если пользователь авторизован, переходим к пункту `1`.
14. Завершаем работу с ошибкой авторизации, возможные варианты: 
    * Неверное имя пользователя и/или пароль
    * Сайт сообщает, что текущий пароль устарел и необходимо задать новый
    * Сайт сообщает, что необходимо ввести капчу

## Распознавание и извлечение информации

**Формат вызова**

`$ ./extract.sh <опции…> [2> <errorFile>]`

В квадратных скобках указана необязательная часть.

**Показать все опции**

`$ ./extract.sh` или `$ cat extract.txt` выводит в консоль терминала:

```
Назначение:
    Распознавание и извлечение именованных сущностей из неструктурированного текста (из файла Markdown)

Использование:
    $ ./extract.sh <опции...>

Опции обязательные:
    --config-file=<значение>   Файл конфигурации (config.*.js)
    --input-file=<значение>    Файл в формате Markdown (*.md)
    --extract-type=<значение>  Тип обработки, возможные значения:
                                 * links — из входящего файла собирается список ссылок на документы и другие списки,
                                   на выходе записывается файл ./log/<input-file-prefix>.links.json
                                 * document — из входящего файла извлекаются именованные сущности,
                                   на выходе записывается файл ./log/<input-file-prefix>.document.json
Опции необязательные:
    --save-tree     Сохранять всю распарсенную структуру данных в файл ./log/<input-file-prefix>.tree.json
                    (только для --extract-type=document)
    --verbose       Выводить подробную/расширенную информацию
    --debug         Режим отладки (записываются файлы ./log/<input-file-prefix>.<step-number>.<step-name>.<extension>
                    с данными для каждого этапа обработки)
    --no-color      Отключить покраску цветом сообщений, выводимых в терминал
    --color         Включить покраску цветом сообщений, если вывод перенаправляется не в терминал

Документация:
    $ cat README.md
```

**Особенности работы**

* Для определения морфологических признаков слов скрипт вызывает консольную программу [Mystem](https://tech.yandex.ru/mystem/doc/) (исполняемый файл `./vendor/bin/mystem`). 

**Потоки**

* В `STDOUT` пишется результат работы (JSON)
* В `STDERR` пишутся сообщения об ошибках

### Типы обработки данных

Существует 2 типа обработки текста в формате Markdown:

* **`links`** — собирается список ссылок на документы и другие списки, на выходе записывается JSON файл `./log/<input-file-prefix>.links.json`.
* **`document`** — извлекаются именованные сущности, на выходе записывается JSON файл `./log/<input-file-prefix>.document.json`. 
  Структура файла определяется распознанными сущностями и словарями, которые использовались для этого. 

В файле `./log/<input-file-prefix>.links.json` хранится JSON объект со следующими свойствами:

Свойство             | Тип                           | Обязательный? | Описание
---------------------|-------------------------------|---------------|---------------------------------------------------------
**source**           | `object`                      | да            | Источник исходной HTML страницы, выгруженной в Markdown
  source.text        | `string`                      | нет           |     Константа, = `source`
  source.url         | `string`                      | да            |     URL ссылки на страницу
  source.title       | `string`                      | нет           |     Заголовок страницы из тега `<title>`
  source.hostAliases | `string`, `array` of `string` | нет           |     Регулярное выражение из параметра `<host>.hostAliases` конфигурационного файла (для информации) 
**lists**            | `array` of `object`           | да            | Список ссылок на списки документов из постраничной навигации.  
  lists[].text       | `string`                      | да            |     Текст ссылки, обычно содержит номер страницы от постраничной навигации
  lists[].url        | `string`                      | да            |     URL ссылки. Все ссылки соответствуют регулярному выражению параметра `<host>.lists.urlMatch` из конфигурационного файла.
  lists[].title      | `string`                      | нет           |     Заголовок ссылки. Соответствует атрибуту `title` тега `a`
**documents**        | `array`of `object`            | да            | Список ссылок на документы
  documents[].text   | `string`                      | да            |     Текст ссылки 
  documents[].url    | `string`                      | да            |     URL ссылки. Все ссылки соответствуют регулярному выражению параметра `<host>.document.urlMatch` из конфигурационного файла.
  documents[].id     | `string`                      | да            |     Идентификатор документа из `documents[].url`. См. параметр `<host>.document.idBackref` из конфигурационного файла.
  documents[].title  | `string`                      | нет           |     Заголовок ссылки. Соответствует атрибуту `title` тега `a`

### Этапы обработки данных

1. Загружаем текст в формате Markdown из файловой системы
2. Загружаем словари из папки `dict`.
3. Конструируем грамматику (шаблоны регулярных выражений) для распознавания именованных сущностей. Для некоторых грамматик используются простые словари.
4. Исправлям ошибочно набранные буквы, которые выглядят одинаково в разной раскладке клавиатуры (поддерживаются русский и английский языки)
5. Если тип обработки — это извлечь ссылки, то делаем это, сохраняем результат в JSON и завершаем работу. Иначе:
6. Токенизируем текст 1-м набором регулярных выражений, заменяем токены на метки-заменители
7. Отделяем друг от друга «прилипшие» слова (например, `РостовНаДону` => `Ростов На Дону`) 
8. Токенизируем текст 2-м набором регулярных выражений, заменяем токены на метки-заменители
9. Лемматизируем текст через `Mystem` и получаем базовую форму слов с [грамматическими признаками](https://tech.yandex.ru/mystem/doc/grammemes-values-docpage/)
10. Заменяем метки-заменители обратно на их значения с разметкой токенов в тексте 
12. Извлекаем из текста токены в одномерный массив объектов токенов `tokensFlat`
13. Из одномерного массива объектов токенов строим многомерный массив (дерево) объектов токенов `tokensTree` следующей вложенной структуры: параграфы, предложения, токены вне ссылок, токены из текста/заголовков ссылок/изображений.
14. Обходим дерево токенов и извлекаем именованные сущности с помощью словарей и правил-эвристик
15. Сохраняем результат в JSON и завершаем работу 

### Группы именованных сущностей

 № | Название          | Описание | Примеры
---|-------------------|----------|-------------------------------------------------------------------------------------
 1 | Шаблонная         | Сущность можно описать шаблоном и идентифицировать [регулярным выражением](https://ru.wikipedia.org/wiki/Регулярные_выражения). | Телефон, email, url, число, валюта, дата, фамилия, отчество
 2 | Словарная простая | Сущность нельзя описать шаблоном. Идентификация происходит через поиск фразы в словаре.                 | Имя человека, город, метро
 3 | Словарная сложная | Идентификация происходит через поиск фразы в словаре и слов, находящихся слева и/или справа от фразы.   | Место работы, время в пути
 4 | Словарно-шаблонная| Сущность необходимо описать словарём и шаблоном одновременно    | Организацоннно правовая форма, после которой стоит название компании в кавычах-ёлочках (`«»`)
 5 | Вычисляемая       | Сущность вычисляется на основе других сущностей и словарей.     | Пол человека (вычисляется из ФИО)

### Типы именованных сущностей

Список типов (разновидностей) объеков токенов, которые могут встречаться в массиве `tokensTree`

Версия структуры данных: **`1.0`**

#### Простые сущности

Тип сущности        | Тип данных | Формат распознанных данных                                               | Название сущности                 | Примеры исходного текста для распознавания                                                                  | Особенности распознавания
--------------------|------------|--------------------------------------------------------------------------|-----------------------------------|-------------------------------------------------------------------------------------------------------------|--------------------------
float               | `number`   |                                                                          | Число с плавающей запятой         | `-74`, <nobr>`84.37`,</nobr> <nobr>`+1.5e-2`,</nobr> <nobr>`129 000`,</nobr> <nobr>`35,000`</nobr>          | Распознаются целые и дробные числа, положительные и отрицательные, с экспонентой и без ([тест](https://regex101.com/r/4qzaqL/2/)). Числа должны соответствовать формату [JSON Number](http://www.json.org/). Дополнительно группы по тысяче могут быть разделены запятой (`,`) или пробелом (` `).
paymentCard         | `integer`  | [Payment card number](https://en.wikipedia.org/wiki/Payment_card_number) | Номер банковской карты            | `4556214349109`, `4539146807121309`, <nobr>`4539 1468 0712 1309`,</nobr> <nobr>`4539-1468-0712-1309`</nobr> | Влияет на корректность распознавания сущности `float`. При распознавании номер валидируется алгоритмом «[Луна](https://ru.wikipedia.org/wiki/Алгоритм_Луна)». Если номер представлен одним числом (только цифрами без разделителей групп) и невалиден, то тип токена меняется на `float`
otherInBrackets     | `string`   |                                                                          | Пунктуация в скобках              | `(?)`, `(!)`                                                                                                | Влияет на корректность распознавания окончаний предложений. В русском языке `(?)` ставится после слова для выражения сомнения или недоумения, `(!)` ставится после слова для выражения автора к чужому тексту (согласия, одобрения или иронии, возмущения)
dashBetweenWord     | `string`   |                                                                          | Дефис между словами               | `Сбербанк-Технологии`, `Григорьев-Апполонов`, `Санкт-Петербург`, `счёт-фактура`, `генерал-майор`, `красно-жёлтый`, `кто-нибудь` | Влияет на корректность извлечения слов с дефисами
bytes               | `string`   |                                                                          | Байты в разных представлениях     | `0xD182D0B5`, `0b101011`, `0o655`, `\xD1\x82\xD0\xB5`, `%D1%82%D0%B5`, `%u0442%u0435`, `\u{442}\u{435}`     | Влияет на корректность распознавания сущностей `float` и `word`.
xmlEntities         | `string`   |                                                                          | HTML сущности                     | `&gt;`, `&Ouml;`, `&#34;`, `&#x02DC;`, `&amp&amp;`                                                          | Влияет на корректность распознавания сущностей `float` и `word`.
xmlTags             | `string`   |                                                                          | HTML теги                         | `<!DOCTYPE html>`, `<IMG border=0 src="<fake> 'fake' &quot;"alt='<fake> "fake" &apos;' /><br/>`             | Влияет на корректность распознавания сущностей `float` и `word`.
word                | `string`   |                                                                          | Слово (последовательность букв с апострофами) | `Работала`, `в`, `ЗАО`, `Самая`, `лучшая`, `компания`                                           | Автоматически исправляются клавиатурные опечатки (буквы, набранные в неверной раскладке клавиатуры). Отделяются друг от друга «прилипшие» слова ([тест](https://regex101.com/r/FndOAq/13/)). Для слова проводится морфологический анализ, извлекается его лемма (базовая форма слова) и его грамматические признаки.
wordPlus            | `string`   |                                                                          | Слово, которое заканчиватся на `+` или `#`    | `C#`, `C++`, [`B+`](https://en.wikipedia.org/wiki/B%2B_tree), <nobr>`Европа+`,</nobr> <nobr>`Google+`</nobr> | Морфологический анализ отсутствует.
IPv4extend          | `string`   | <nobr>[IPv4](https://en.wikipedia.org/wiki/IPv4)</nobr>                  | Internet Protocol version 4       | <nobr>`192.168.1.1/24`,</nobr> <nobr>`192.168.1.33:3128`,</nobr> <nobr>`255.255.255.0`</nobr>               | Влияет на корректность распознавания сущности `float`. IPv4 может быть указано вместе с портом или подсетью.
macAddress          | `string`   | <nobr>[MAC address](https://en.wikipedia.org/wiki/MAC_address)</nobr>    | Media access control address      | <nobr>`e0:69:95:78:13:53`</nobr>                                                                            | Влияет на корректность распознавания сущности `float`
date                | `string`   | <nobr>`YYYY-MM-DD`</nobr>                                                | Дата (число, месяц, год)          | <nobr>`31.01.2017`</nobr>, <nobr>`29/02/2000`,</nobr> <nobr>`2017-01-01`,</nobr> <nobr>`31 July 2017`,</nobr> <nobr>`31 января 2017`,</nobr> <nobr>`16 мая, 16:25`</nobr> | Если год не указан, то подразумевается текущий год.
time                | `string`   | <nobr>`hh:mm[:ss]`</nobr>                                                | Время (часы, минуты, секунды)     | `14:59`, <nobr>`02:30:59 PM`</nobr>                                                                         | Если секунды не указаны, то подразумевается `00`.
dateTime            | `string`   | <nobr>[ISO 8601](https://en.wikipedia.org/wiki/ISO_8601)</nobr>          | Дата и время                      | <nobr>`28 мая, 18:33` (локально)</nobr>, <nobr>`Wed, 14 Jun 2017 00:00:00 PDT` (UTC),</nobr> <nobr>`Mon, 18 Dec 1995 17:28:35 GMT` (GMT),</nobr> <nobr>`2011-10-05T14:48:00.000Z` (ISO 8601)</nobr> | После значения даты должно следовать значение времени 
currencyBeforeFloat | `string`   | <nobr>[ISO 4217 code](https://en.wikipedia.org/wiki/ISO_4217)</nobr>     | Валюта, расположенная до числа    | `€50`, `$ 17.5`
currencyAfterFloat  | `string`   | <nobr>[ISO 4217 code](https://en.wikipedia.org/wiki/ISO_4217)</nobr>     | Валюта, расположенная после числа | `100$`, `35 EUR`, `35,000 руб.`
linkUrl             | `string`   | <nobr>[URL](https://en.wikipedia.org/wiki/URL)</nobr>                    | Ссылка на страницу или ресурс     | Начинается с протокола: <nobr>`http://site.com/path/to/?ключ=значение&key[1]=value1#привет`,</nobr> <nobr>`protocol://user:pass@site.com:8080/path/page?a=1&b=2#hash`,</nobr> <nobr>`https://МШП.рф/`,</nobr> <nobr>`http://xn--80aald4bq.xn--d1aqf.xn--p1ai/`;</nobr><br/> начинается с <nobr>`www.`:</nobr> <nobr>`www.ru`,</nobr> <nobr>`www.bfm.ru`;</nobr><br/> содержит `/` после домена: <nobr>`GitHub.com/username`</nobr>
email               | `string`   | <nobr>[Email](https://en.wikipedia.org/wiki/Email_address)</nobr>        | Адрес электронной почты           | <nobr>`MikeParker@OneDollar.Us`,</nobr> <nobr>`Иванов.Иван@Санкт-Петербург.онлайн`,</nobr> [ещё](https://regex101.com/r/Q4dsL5/14)
phone               | `string`   |                                                                          | Номер телефона                    | Международный формат: <nobr>`+7 926 1234567`,</nobr> <nobr>`+7 965 123 45 67`,</nobr> <nobr>`+7 968 123-45-67`,</nobr> <nobr>`+7(965)123-45-67`,</nobr> <nobr>`+7 (095) 361-999-1`,</nobr> <nobr>`+7 (83166) 1-23-45`,</nobr> <nobr>`+7 831 66 1-23-45`,</nobr> <nobr>`+1-800-MY-APPLE`</nobr>, <nobr>`+971 2 4567890`,</nobr> <nobr>`+971-50-123-45-67`,</nobr> <nobr>`+54 9 2982 123456`,</nobr> <nobr>`+373 68 007777`;</nobr> Локальный формат: <nobr>`8(965)1234567`,</nobr> <nobr>`8 (095) 361-999-1`,</nobr> <nobr>`8 8316 123 4 56`</nobr>
header              | `string`   |                                                                          | Markdown заголовок                | `# Заголовок`, `## Раздел`, `### Подраздел`                                                                 | Аналогия с HTML: `<h1>Заголовок</h1>`, ... `<h5>Подраздел</h5>`
listItem            | `string`   |                                                                          | Markdown элемент списка           | `* Элемент списка`                                                                                          | Аналогия с HTML: `<ul><li>Элемент списка</li></ul>`
**link**            | `object`   |                                                                          | **Markdown ссылка**               | `[текст](url "заголовок")`            | Извлекается текст, ссылка и заголовок. Аналогия с HTML: `<a href="url" title="заголовок">текст</a>`
link.text           |   `string` |                                                                          | Текст ссылки
link.url            |   `string` | <nobr>[URL](https://en.wikipedia.org/wiki/URL)</nobr>                    | URL ссылки
link.title          |   `string` |                                                                          | Заголовок ссылки
**image**           | `object`   |                                                                          | **Markdown изображение**          | `![img.round#photo](url "заголовок")` | Извлекается CSS селектор, ссылка и заголовок. Аналогия с HTML: `<img src="url" alt="заголовок" class="round" id="photo"/>`
image.url           |   `string` | <nobr>[URL](https://en.wikipedia.org/wiki/URL)</nobr>                    | URL изображения
image.title         |   `string` |                                                                          | Заголовок изображения
sentence            | `string`   |                                                                          | Граница предложения               |                                       | Применяется для преобразования распарсенных данных из массива `tokensFlat` в `tokensTree`. Некоторые (но не все!) правила для определения границ предложений: описаны [здесь](ttps://orfogrammka.ru/справочник/справочник_по_русскому_языку_пунктуация_розенталь/), [здесь](http://sphinxsearch.com/docs/current.html#conf-index-sp) и [здесь](http://www.dialog-21.ru/digest/2000/articles/bezverbny/). 
paragraph           | `string`   |                                                                          | Граница параграфа                 |                                       | Применяется для преобразования распарсенных данных из массива `tokensFlat` в `tokensTree`.

#### Сложные сущности

Свойство может отсутствовать (или иметь значение `null`), если данные отсутствуют в исходном тексте или их не удалось распознать

Тип сущности                    | Тип данных            | Название сущности                  | Примечания
--------------------------------|-----------------------|------------------------------------|----------------
birthDate                       | `date`                | Дата рождения                      | 
**money**                       | `object`              | **Денежный тип**                   | 
  money.float                   |   `number`            |   Число с плавающей запятой        | 
  money.currency                |   `string`            |   Код валюты                       | Значение должно соответствовать <nobr>[ISO 4217 code](https://en.wikipedia.org/wiki/ISO_4217)</nobr> 
salary                          | `money`               | Зарплата                           |
**place**                       | `object`              | **Местоположение**                 | 
  place.country                 |   `string`            |   Название страны                  | Элемент справочника
  place.region                  |   `string`            |   Название региона                 | Элемент справочника. Регион для РФ — это республика, край, область или автономный округ.
  place.city                    |   `string`            |   Название города                  | Элемент справочника
  place.address                 |   `string`            |   Адрес                            | 
  place.lat                     |   `number`            |   Географическая широта            | 
  place.lng                     |   `number`            |   Географическая долгота           | 
  **place.metro**               |   `object`            |   **Метро**                        | 
  place.metro.name              |     `string`          |   Название станции метро           | Элемент справочника
  place.metro.order             |     `integer`         |   Порядковый номер станции на линии метро
  place.metro.line              |     `object`          |   Линия (ветка) метро              |
  place.metro.line.name         |       `string`        |   Название линии метро             | Элемент справочника 
  place.metro.line.hexColor     |       `string`        |   Цвет линии метро                 | 
**company**                     | `object`	            | **Компания/организация**           |
  company.name                  |   `string`	        |   Название организации             |
  company.url	                |   `string`	        |   Cайт организации                 |
  company.place	                |   `place`             |   Местоположение организации       |
  company.description           |   `string`            |   Описание организации             |
**recommendation**              | `array` of `object`   | **Список рекомендаций**            |
  recommendation[].person       |   `person`	        |   Персона, написавшая рекомендацию | Используется ФИО, должность, ссылка на профиль соц. сети
  recommendation[].company	    |   `company`	        |   Компания/организация             |
  recommendation[].description  |   `string`	        |   Текст рекомендации               |
**person**                      | `object`              | **Персона (физическое лицо)**      | 
  person.firstName              |   `string`            |   Имя                              |
  person.lastName               |   `string`            |   Фамилия                          | 
  person.middleName             |   `string`            |   Отчество                         | 
  person.gender                 |   `string`            |   Пол                              | Пол определяется по ФИО, одно из значений: `m` (мужской), `f` (женский) или пустая строка, если определить не удалось
  person.birthDate              |   `date`              |   Дата рождения                    | 
  person.place                  |   `place`             |   Местоположение (место жительства)| 
  person.citizenship	        |   `array` of `place`	|   Список гражданств                | Элементы справочника местоположений (используется только страна)
  person.email                  |   `email`             |   Адрес электронной почты          |
  person.photo                  |   `image`             |   Фотография                       |
  person.maritalStatus          |   `string`            |   Семейное положение               | Элемент [справочника](dict/person.marital_status.csv)
  person.childrenStatus         |   `string`            |   Наличие детей                    | Элемент [справочника](dict/person.children_status.csv)
  person.hasCar	                |   `boolean`	        |   Наличие личного автомобиля
  person.drivingLicense         |   `array` of `string` |   Список категорий водительских прав                    | Элемент [справочника](dict/person.driving_license.csv)
  person.link                   |   `array` of `link`   |   Список профилей в социальных сетях и других сервисах  |
  person.portfolio              |   `array` of `image`  |   Список изображений из портфолио
  person.skillProfessional      |   `array` of `string` |   Список профессиональных навыков | Элемент [справочника](dict/person.skill_professional.csv)
  person.skillExtra             |   `string`            |	Дополнительная информация, описание навыков в свободной форме
  person.additionalInfo         |   `string`                | Дополнительная информация
  person.recommendation         |   `array` of `recommendation` | Список рекомендаций
  **person.phone**              | `array` of `object`       | **Список телефонов**
  person.phone.number           |   `phone`                 |   Номер телефона                   |
  person.phone.timeBegin        |   `time`                  |   Время с которого можно звонить   |
  person.phone.timeEnd          |   `time`                  |   Время до которого можно звонить  |
  person.phone.comment          |   `string`                |   Комментарий для звонка
  **person.education**	            | `array` of `object`	| **Список образований**
  person.education[].type           |   `string`	        |   Тип образования                 | Элемент [справочника](dict/person.education_type.csv) 
  person.education[].name	        |   `string`	        |   Название учебного заведения или название курса/тенинга/теста/экзамена
  person.education[].organization   |   `string`, `company` |   Факультет учебного заведения или организация, проводившая курс/тренинг/тест/экзамен
  person.education[].profession	    |   `string`	        |   Специальность / специализация
  person.education[].yearEnd        |   `integer`	        |   Год окончания
  person.educationLevel             | `string`              |   Уровень образования              | Элемент [справочника](dict/person.education_level.csv)
  **person.language**               | `array` of `object`   | **Список уровней владения языком**
  person.language[].name            |   `string`            |   Язык                             | Элемент [справочника](dict/person.language_name.en.json)
  person.language[].level           |   `string`            |   Уровень владения                 | Элемент [справочника](dict/person.language_level.csv)
  **person.relocation**             |   `object`            | **Готовность к переезду**
  person.relocation.type            |     `string`          |   Тип готовности к переезду        | Элемент [справочника](dict/person.relocation_type.csv) 
  person.relocation.place           |     `array` of `place`|   Список местоположений (городов), в которые возможен переезд 
  **person.certificate**            | `array` of `object`	| **Список сертификатов**
  person.certificate[].title	    |   `string`	        |   Название сертификата
  person.certificate[].dateBegin	|   `date`	            |   Дата получения сертификата
  person.certificate[].image	    |   `image`	            |   Ссылка на изображение сертификата
  person.certificate[].link	        |   `link`	            |   Ссылка на описание сертификата
  **person.work**                   | `object`              | **Сведения о работе**
  person.work.position              |   `string`            |   Желаемая должность
  person.work.salary                |   `salary`            |   Желаемая зарплата
  person.work.salaryBegin           |   `salary`            |   Желаемая зарплата от
  person.work.salaryEnd             |   `salary`            |   Желаемая зарплата до
  person.work.businessTripReadiness |   `string`            |   Готовность к командировкам | Элемент [справочника](dict/person.business_trip_readiness.csv)
  person.work.licence               |   `array` of `place`	|   Список регионов, в которых есть разрешение на работу | Элементы справочника местоположений (используется страна, регион, город)
  person.work.schedule              |   `array` of `string` |   Список подходящих графиков работы и типов занятости | Элемент [справочника](dict/work.schedule.csv)
  person.work.placeType             |   `string`            |   Тип места работы | Элемент [справочника](dict/work.place_type.csv)
  person.work.travelTime            |   `string`            |   Желательное время в пути до работы | Элемент [справочника](dict/work.travel_time.csv)
  **person.work.specialization**          | `array` of `object`           | **Список профессиональных областей и специализаций** | Элемент справочника 
  person.work.specialization[].name       |   `string`                    |   Название специализации 
  person.work.specialization[].profarea   |   `string`                    |   Название профессиональной области, в которую входит специализация
  **person.work.experience**	          | `array` of `object`	          | **Список с опытом работы**
  person.work.experience[].company        |   `company`	                  |   Организация
  person.work.experience[].industries	  |   `array` of `string`         |   Cписок отраслей компании | Элемент [справочника](dict/company.industry.rabota.csv)
  person.work.experience[].position	      |   `string`	                  |   Должность
  person.work.experience[].dateBegin      |   `date`	                  |   Начало работы 
  person.work.experience[].dateEnd	      |   `date`                      |   Окончание работы
  person.work.experience[].description	  |   `string`	                  |   Обязанности, функции, достижения | Вместо этого поля может быть 2 отдельных поля: обязанности, достижения 
  person.work.experience[].responsibility |   `string`	                  |   Обязанности
  person.work.experience[].achievement    |   `string`	                  |   Достижения
  person.work.experience[].recommendation |   `array` of `recommendation` |   Список рекомендаций
  person.work.experience[].portfolio      |   `array` of `image`          |   Список изображений из портфолио

#### Служебные сущности

В распознанных данных есть служебный блок с мета-информацией.

Тип сущности                    | Тип данных            | Название сущности                  | Примечания
--------------------------------|-----------------------|------------------------------------|----------------
**meta**                        | `object`              | Мета-информация                    |
  meta.verson                   | `string`              | Версия                             | Позволяет поддерживать несколько версий структуры данных распознаных сущностей
  meta.source                   | `object`              | Источник загрузки                  |
  meta.source.url               | `string`              | Ссылка на страницу или ресурс      |

### Словари (справочники)

Словари применяются для распознавания именованных сущностей и хранятся в отдельных файлах в папке `dict`.
При старте скрипта они загружаются в оперативную память компьютера в [хеш-таблицу](https://ru.wikipedia.org/wiki/Хеш-таблица).
Словари имеют первичный ключ (уникальный индекс), по которому можно проверить существование значения или получить дополнительную информацию в словаре.

Для поддержания порядка и корректной работы скрипта приняты следующие соглашения:

* Формат словарей: [JSON](http://www.json.org/) или [CSV](https://ru.wikipedia.org/wiki/CSV)
* Названия файлов должны состоять из латинских букв в нижнем регистре, цифр, знаков подчёркивания и точек. Расширение файлов: `.json` или `.csv`.  
* Слова в названии файлов словарей должны быть в единственном числе.
* Слова и фразы, которые находятся внутри словарей, должны быть в исходной/базовой форме. 
Как правило это [именительный падеж](http://rusgram.ru/Именительный_падеж) [едиственного числа](https://ru.wikipedia.org/wiki/Единственное_число).
* В CSV словарях значения из первой колонки по умолчанию используются в качестве первичного ключа словаря.

### Описание внутренних структур данных

Распарсенные данные хранятся в 2-х массивах:
* `tokensFlat` — элементами массива являются объекты токенов. 
  Массив `tokensFlat` необходим для получения исходного фрагмента текста по заданной начальной и конечной позиции токенов.
* `tokensTree` — элементами массива являются массивы или объекты токенов. 
  Массив `tokensTree` необходим для глубокой структуризации документа на параграфы и предложения, выделения ссылок и обнаружения именованных сущностей.

В массиве `tokensTree` токен представляет собой объект со следующими свойствами:

Свойство             | Тип                          | Обязательный?              | Описание
---------------------|------------------------------|----------------------------|---------------------------------------------------------
type                 | `string`                     | да                         | Тип токена
value                | `number`, `string`, `object` | да                         | Значение токена
  value.\<nameN\>    | `number`, `string`, `object` | да                         | Объект должен иметь одно или несколько свойств, их состав зависит от типа токена. Значениями свойств должны быть строки/числа/объекты. Для примера см. описание токена `person` 
tokensFlatRange      | `array` of `integer`         | да                         | Позиция токена в массиве `tokensFlat`  
  tokensFlatRange[0] | `integer`                    | да                         | Начало позиции
  tokensFlatRange[1] | `integer`                    | да                         | Окончание позиции
lang                 | `string`                     | да, если тип токена `word` | Язык слова, возможные значения: `ru`, `en` 
textTransform        | `string`                     | да, если тип токена `word` | Трансформация слова, возможные значения: `capitalize`, `lowercase`, `uppercase`
grams                | `array` of `object`          | да, если тип токена `word` | Массив объектов с грамматической информацией           
  grams[].lemma      | `string`                     | да, если тип токена `word` | Базовая форма слова
  grams[].weight     | `number`                     | да, если тип токена `word` | Вес грамматической формы, число от `0` до `1`
  grams[].attrs      | `array` of `string`          | да, если тип токена `word` | Массив строк с [грамматическими признаками](https://tech.yandex.ru/mystem/doc/grammemes-values-docpage/), например `["S", "муж", "неод", "род,мн"]`
linkText             | `array` of `object`          | да, если тип токена `link` | Массив объектов токенов для текста ссылки 
linkTitle            | `array` of `object`          | да, если тип токена `link` | Массив объектов токенов для заголовка ссылки
imageTitle           | `array` of `object`          | да, если тип токена `image`| Массив объектов токенов для заголовка изображения
imageSelector        | `string`                     | да, если тип токена `image`| CSS селектор изображения

# Файл конфигурации

Файл `config.*.js` представляет из себя NodeJS модуль, который экспортирует JavaScript объект следующей структуры:

Свойство                            | Тип                                     | Обязательный?| Описание
------------------------------------|-----------------------------------------|--------------|---------------------------------------------------------
**\<host\>**                        | `object`                                | да           | **Секция с настройками для хоста `<host>`**. Рекомендуется указываеть в нижнем регистре. Порт указывается опционально через двоеточие, примеры: `site.com`, `site.com:8080`. Для скрипта `import.sh` имя хоста берётся из URL, который передаётся скрипту в параметре `--url`. Для скрипта `extract.sh` имя хоста берётся из URL ссылки `source`, которая находится внизу `*.md` файла.
  \<host\>.hostAliases              | `regexp`, `string`, `array` of `string` | нет          |   Псевдонимы хостов. Например, «зеркала» или региональные поддомены.
  \<host\>.resourceHostAllow        | `regexp`, `string`, `array` of `string` | нет          |   «Белый» список хостов, с которых разрешено загружать ресурсы веб-страницы (`*.js`, `*.css`, `…`). Если не указано, то разрешена загрузка со любых хостов.
  \<host\>.resourceHostDisallow     | `regexp`, `string`, `array` of `string` | нет          |   «Чёрный» список хостов, с которых запрещено загружать ресурсы веб-страницы (`*.js`, `*.css`, `…`). Сначала проверяется «чёрный» список, потом «белый».
**\<host\>.lists**                  | `object`                                | да           | **Секция с настройками для обработки страниц со ссылками на документы**
  \<host\>.lists.urlMatch           |   `regexp`                              | да           |   Регулярное выражение для захвата ссылок на списки документов (постраничная навигация). Псевдонимы хостов должны быть учтены. Если на сайте применяется AJAX (HTTP заголовок `X-Requested-With: XMLHttpRequest`) динамическая подгрузка списка ссылок (например, при клике на кнопку/ссылку «далее» или при прокрутке страницы вниз), то URL формируется из `location.href` по правилам, указанным в параметре `urlReplacements`.
  \<host\>.lists.ready              |   `function`                            | нет          |   См. `<host>.document.ready`
  \<host\>.lists.wait               |   `function`                            | нет          |   См. `<host>.document.wait`
  \<host\>.lists.urlReplacements    |   `array` of `array`                    | нет          |   См. `<host>.document.urlReplacements`    
**\<host\>.document**               | `object`                                | да           | **Секция с настройками обработки страниц документов**
  \<host\>.document.urlMatch        |   `regexp`                              | да           |   Регулярное выражение для захвата ссылок на документы. Псевдонимы хостов должны быть учтены.
  \<host\>.document.idBackref       |   `integer`                             | нет          |   Номер группы из рег. выражения в `urlMatch`, в котором захватывается идентификатор документа. Для декодирования части URL будет вызван [`decodeURIComponent()`](https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/decodeURIComponent)
  \<host\>.document.ready           |   `function`                            | нет          |   Функция, которая будет выполнена в браузере после построения DOM. Должна возвратить `boolean`. Функции `ready` и `wait` работают в паре!!!
  \<host\>.document.wait            |   `function`                            | нет          |   Если функция `ready` вернёт true, то функция `wait` будет периодически вызываться в браузере до тех пор, пока не возвратит `true`, или пока время ожидания (равно времени ожидания загрузки ресурсов) не истечёт. Затем скрипт сохранит содержимое страницы в файлы `*.dom.html` и `*.md` и завершит работу. Если функция `ready` вернёт `false`, сохранение в файл будет сделано сразу без вызова `wait`.
  \<host\>.document.urlReplacements |   `array` of `array`                    | нет          |   Массив для трансформации URL (добавление/удаление/замена путей и GET параметров). Каждый элемент массива является массивом с указанием пар замен: строка или рег. выражение для поиска, строка для замены. Подробнее см. на http://xregexp.com/api/#replaceEach
  \<host\>.document.cssSelector     |   `string`                              | нет          |   [CSS селектор](http://api.jquery.com/category/Selectors/), который используется для выбора нужного элемента при конвертации из DOM HTML в Markdown. По умолчанию это `body`.
**\<host\>.auth**                   | `object`                                | нет          | **Секция с настройками авторизации пользователя на сайте**
  \<host\>.auth.url                 |   `string`                              | да           |   Адрес страницы, на которой гарантированно должна быть форма авторизации с полями ввода имени пользователя и пароля 
  \<host\>.auth.username            |   `string`                              | да           |   Имя пользователя для заполнения формы авторизации. Значение можно передать через ключ командной строки `--username`
  \<host\>.auth.password            |   `string`                              | да           |   Пароль для заполнения формы авторизации. Значение можно передать через ключ командной строки `--password`
  \<host\>.auth.delay               |   `number`                              | нет          |   Ожидание в секундах перед отправкой данных формы ввода на сервер
  \<host\>.auth.cookiesFile         |   `string`                              | нет          |   Файл со списком кук вместо авторизации по логину и паролю (восстановление чужой сессии). Список кук должен быть в формате Firefox плагина "[Cookies Manager+](https://github.com/vanowm/FirefoxCookiesManagerPlus/)" (`*.txt`) или в формате Firefox плагина "[Сookie Quick Manager](https://github.com/ysard/cookie-quick-manager/)" (`*.json`). Значение можно передать через ключ командной строки `--cookies-file`
